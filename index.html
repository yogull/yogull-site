// Firebase is loaded via <script> tag in index.html, so we can declare it here for TypeScript.
declare var firebase: any;

// Firebase Initialization
const firebaseConfig = {
    apiKey: "AIzaSyAxHlbxOi8qJg8LjrglHZgxZ7qliqg-njI",
    authDomain: "gohealme-9bdf0.firebaseapp.com",
    projectId: "gohealme-9bdf0",
    storageBucket: "gohealme-9bdf0.appspot.com",
    messagingSenderId: "823297665017",
    appId: "1:823297665017:web:3427ba4397e12447ccbf28"
};
const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Auth State Handler
auth.onAuthStateChanged((user: any) => {
    if (user) {
        window.location.href = 'dashboard.html';
    }
});

// Email Auth
async function signInWithEmail() {
    const button = document.querySelector('.login-btn') as HTMLButtonElement;
    if (!button) return;
    const originalHtml = button.innerHTML;
    try {
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing In...';
        button.disabled = true;
        const email = (document.getElementById('email') as HTMLInputElement).value;
        const password = (document.getElementById('password') as HTMLInputElement).value;
        await auth.signInWithEmailAndPassword(email, password);
    } catch (error) {
        alert(`Sign in failed: ${(error as Error).message}`);
    } finally {
        button.innerHTML = originalHtml;
        button.disabled = false;
    }
}

// Social Auth (Google)
async function signInWithGoogle() {
    const button = document.querySelector('.google-btn') as HTMLButtonElement;
    if (!button) return;
    const originalHtml = button.innerHTML;
    try {
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
        button.disabled = true;
        await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    } catch (error) {
        alert(`Google sign-in failed: ${(error as Error).message}`);
    } finally {
        button.innerHTML = originalHtml;
        button.disabled = false;
    }
}

// Social Auth (Facebook)
async function signInWithFacebook() {
    const button = document.querySelector('.facebook-btn') as HTMLButtonElement;
    if (!button) return;
    const originalHtml = button.innerHTML;
    try {
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
        button.disabled = true;
        await auth.signInWithPopup(new firebase.auth.FacebookAuthProvider());
    } catch (error) {
        alert(`Facebook sign-in failed: ${(error as Error).message}`);
    } finally {
        button.innerHTML = originalHtml;
        button.disabled = false;
    }
}

// Show Sign Up Form (placeholder)
function showSignUp(event: MouseEvent) {
    event.preventDefault();
    alert('Sign up form will appear here!');
}

// Add event listeners to the buttons
document.querySelector('.login-btn')?.addEventListener('click', signInWithEmail);
document.querySelector('.google-btn')?.addEventListener('click', signInWithGoogle);
document.querySelector('.facebook-btn')?.addEventListener('click', signInWithFacebook);
document.getElementById('signup-link')?.addEventListener('click', showSignUp);
